\chapter{Data analysis}
\label{chap:DataAnalysis}
\section{Data description}
Flight ticket prices were collected 4~times per day for a period ranging from the $9^{th}$ of July till the $29^{th}$ of September. During this data collection phase, airfares on the 22~routes described in \autoref{app:SelectedRoutes} were gathered on flights departing from the $20^{th}$ of August till the $30^{th}$ of September. In these 12~weeks, 158,553~files were requested from Google~Flights' RPC-servers, which resulted in a set of almost 18~gigabites of JSON~data. 15~of these requests failed at the first try, and had to be downloaded again one quarter of an hour later. Of these retries, the automated script also failed to download 2~files at the second request. These failures were the request made on the $20^{th}$ of September at 00:00 GMT+2 for flights departing from JFK to LHR on the $25^{th}$ of September and the request made on the $26^{th}$ of July at 00:00 GMT+2 for flights departing from LHR to LAX on the $1^{st}$ of July. As the next paragraphs will explain, these two~failures did not create any gaps of missing data in the final data structure.

After retrieval of the data all the JSON-files were parsed for single-legged return flights and categorized by outbound/inbound airport, and operating carrier. Each flight was distinguished using the characteristics described in \autoref{subsec:FlightTicket}, and departure times were converted to UTC\@. Next, the timeslot $p_{t_n}$ of the lookup time relative to the actual departure time was determined for each flight, where $n = \lfloor \frac{\scriptstyle{hours\ before\ departure}}{6} \rfloor + 1$. Because files were downloaded for 4~times per day, they can be assigned to timeslots consisting of 6~hours. For example, an airfare retrieved 33 hours before departure of the flight will be assigned to timeslot $p_{t_6}$, where $6 = \lfloor \frac{33}{6} \rfloor + 1$. Because ticket prices were acquired from 1~day up until 42~days before departure, a total of 168~timeslots are available ranging from $p_{t_5}$ till $p_{t_{172}}$.

After parsing of the files, the prices of the 6~hour timeslots were converted to represent daily values. To do so, every 4~timeslots where thus aggregated into a single airfare by averaging the values. For instance, the timeslots $p_{t_{17}}$, $p_{t_{18}}$, $p_{t_{19}}$ and $p_{t_{20}}$ were averaged into a single value $p_{d_4}$ representing the ticket price for that specific flight as available 4~days before departure.

\noindent
An illustration of this process is given in \autoref{fig:conversionOfTimeslotsIntoDailyAirfares}.

\begin{figure}
$$
\kbordermatrix{
           &\multispan4\hfill$\scriptstyle 1\,dbd$\hfill    &        \\
    \omit  &\multispan4\quad\downbracefill\quad             &        \\
    \#1    & p_{t_5} & p_{t_6} & p_{t_7} & p_{t_8} & \vrule & \cdots \\
    \#2    & p_{t_5} & p_{t_6} & p_{t_7} & p_{t_8} & \vrule & \cdots \\
    \vdots & \vdots  & \vdots  & \vdots  & \vdots  & \vrule & \ddots \\
    \#n    & p_{t_5} & p_{t_6} & p_{t_7} & p_{t_8} & \vrule & \cdots 
}
\Rightarrow
\kbordermatrix{
           & 1\,\scriptstyle{dbd}       & \cdots & 42\,\scriptstyle{dbd}              \\
    \#1    & \overline{p_{t_{5,6,7,8}}} & \cdots & \overline{p_{t_{169,170,171,172}}} \\
    \#2    & \overline{p_{t_{5,6,7,8}}} & \cdots & \overline{p_{t_{169,170,171,172}}} \\
    \vdots & \vdots                     & \ddots & \vdots                             \\
    \#n    & \overline{p_{t_{5,6,7,8}}} & \cdots & \overline{p_{t_{169,170,171,172}}}
}
$$
\caption{Conversion of timeslots into daily airfares}
\label{fig:conversionOfTimeslotsIntoDailyAirfares}
\end{figure}

When certain timeslots contain no price observation, this single timeslot is left out of the calculation of the average airfare for that specific number of days before departure. Only when all 4~of the timeslots for a specific day have no data available, the value in the new data matrix is assigned as \emph{missing value} (i.e., n/a). Due to this methodology in which the daily 4~data~points are aggregated into a single value, the 2~failures described earlier do not create any gaps of missing values in the final data matrix. \todo{analysis}

The conversion into daily values resulted in a database containing 462,662 unique flights which included 12,865,953 airfare observations. Due to Google Flights' nature of returning a limited set of airfares for each request, some flights did contain gaps of missing values within their data. In alignment with the study by \citeA{groves2013agent}, this paper therefore excludes flights for which less than $\frac{2}{3}$ of the possible airfare observations are available. So, because there are a total of 42~observations days prior to each flight, tickets that do have fewer points than $42 \times \frac{2}{3} = 28$ available will be excluded from the analysis. Next, because airlines are known to open and close specific price-buckets \cite{mcgill1999revenue}, some gaps were still present in the dataset. These gaps were filled with the data available from observations made in the future. For example, when a particular flight misses a price observation at 35~days before departure, but it does contain the airfare for 34 and 36~days prior to departure, the 35~days' slot would be filled with the same value as the 34~days before departure. In reality this would mean that when a customer's option expires, but the ticket is not available on the date of maturity (i.e., no price observation). The customer thus would have to wait till the airline resumes the sale of that flight. He would therefore get the ticket at the price in the future.

Missing data at for the last (few) days prior to departure are considered to be the sell-out of a flight. Because Google Flight's also offers Business and First class tickets, this implies that all the seats are completely sold out, and there is no possibility of still buying the ticket. This means that when a customer's option expires on such a ticket and he wishes to exercise it, an alternative flight has to be offered. To prevent such situations from happening, these missing data on sold-out flights is filled with a penalty similar to the technique used by \citeA{etzioni03}. By introducing such a penalty, the option valuation model is triggered into trying not to offer options when the probability of sell-out is high. Instead of the \$300,000 proposed by the authors, I have chosen to set the penalty at 3 times the average airfare at 1~day before departure. This is more realistic in a sense that the customer could be offered an alternative flight that leaves on the same day plus some extra form of monetary compensation. Furthermore this lower fill-value prevents penalties from biasing the airfares closer to departure.

An illustration of this data filling process is given in \autoref{fig:dataFillingOfMissingValues}. Airfares are given as integers representing the price in cents. As can be seen in the figure, the n/a-gaps are filled with the nearest available future price closer to departure. Furthermore, the missing value for theflight with id~\#3 at 1~day before departure is seen as a sold-out ticket. This value is filled with $3 \times \bar{c_1}$, where $\bar{c_1}$ represents the average of the airfares observed at a single day before departure.

\begin{figure}
$$
\kbordermatrix{
           & 1\,\scriptstyle{dbd} & 2\,\scriptstyle{dbd} & 3\,\scriptstyle{dbd}  & \cdots \\
    \#1    & 10000                & 12000                & 12000                 & \cdots \\
    \#2    & 20000                & \mathrm{n/a}         & 22000                 & \cdots \\
    \#3    & \mathrm{n/a}         & 32000                & \mathrm{n/a}          & \cdots \\
    \vdots & \vdots               & \vdots               & \vdots                & \ddots
}
\Rightarrow
\kbordermatrix{
           & 1\,\scriptstyle{dbd} & 2\,\scriptstyle{dbd} & 3\,\scriptstyle{dbd}  & \cdots \\
    \#1    & 10000                & 12000                & 12000                 & \cdots \\
    \#2    & 20000                & 20000                & 22000                 & \cdots \\
    \#3    & 3 \cdot \bar{c_1}    & 32000                & 32000                 & \cdots \\
    \vdots & \vdots               & \vdots               & \vdots                & \ddots
}
$$
\caption{Data filling of missing values (i.e., n/a)}
\label{fig:dataFillingOfMissingValues}
\end{figure}

The empirical dataset shows that in total 159,600 flights are not offered (i.e., sold-out) at 1~day before departure. These tickets take into account almost 35 percent of the all the flights available. Real-world data on the number of sold-out flights is very hard to acquire, because this value could give sensitive information on the performance of an airline.  \todo{Kindervater?}


After cleaning the dataset, it was split into two separate parts. The database used in this research contains airfare observations of flights departing in the period $20^{th}$ of August till the $30^{th}$ of September. As explained in \autoref{chap:Methodology}, the first 4~weeks of these departing flights --- $20^{th}$ of August till the $16^{th}$ of September --- will be used as the training set for the research. The latter 2~weeks --- from the $17^{th}$ of September till the $30^{th}$ of September --- will be used for testing the proposed option valuation models. This split resulted in a training set containing 321,545 flights, and a test set which includes 141,117 flights. An example extract of the final test data matrix used for the flights from AMS to JFK can be found in \autoref{fig:extractFromAMStoJFK}. In this extract, flight with id~\#4 was sold-out 1~day before departure, and that field was thus filled with $3 \times$ the average ticket price at 1~day before departure.

\begin{figure}
$$
\kbordermatrix{
           & 1\,dbd & 2\,dbd & 3\,dbd & 4\,dbd & 5\,dbd & \ldots & 42\,dbd \\
    \#1    & 57469  & 68619  & 122469 & 222469 & 109644 & \ldots & 65853   \\
    \#2    & 87119  & 87369  & 93019  & 84469  & 79469  & \ldots & 65853   \\
    \#3    & 87494  & 86694  & 94744  & 74569  & 70244  & \ldots & 65853   \\
    \#4    & 410951 & 134430 & 242480 & 108934 & 126369 & \ldots & 123357  \\
    \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \ddots & \vdots  \\
    \#252  & 68984  & 69094  & 64669  & 73219  & 70244  & \ldots & 65857
}
$$
\caption{Sample extract from test data matrix AMS to JFK}
\label{fig:extractFromAMStoJFK}
\end{figure}

\noindent
A further analysis of these datasets, including more specific statistical numbers on the 22~routes, can be found in \todo{table ref}

\todo[Table]{table with analysis of sets}


\section{Simulation model}
\todo{general descr}

\todo{change chaptering}

\subsection{Simulation process description}
In this paper a series of simulations will be run to determine the performance of the proposed option valuation models. The simulation model will calculate the expected profits or losses of each of these models. To do so, it will run through a number of steps, namely:

\begin{description}
\item[Generate passengers] the simulation model will generate a single passenger for each day prior to departure of a specific flight. Because data have been collected on flights up till 42~days before departure, each ticket will receive this same number of passengers with option requests. However, because when selling options with a specific number of days to maturity $m$ it is not possible to buy options fewer that $m$ days to departure, these customers get excluded from the model. As an example, the test dataset containing airfares of tickets from LHR to JFK includes 7,690 unique flights after cleansing. When simulating this model for options with a maturity of 3 days a total of $(42 - 3) \times 7,690 = 299,910$ passengers will be generated.
\item[Calculate the passenger's WTP] the passenger's \emph{Willingness To Pay} is determined by calculating the minimum costs incurred when buying the flight immediately or waiting to buy the ticket at maturity. A more complete explanation of this concept can be found in \typenameref{subsec:PassengersWTP}. For the simulation the equation takes into account several properties of a passenger. These parameters are \begin{inparaenum}[\itshape (i)\upshape]
    \item risk-utility,
    \item forecasting technique, and
    \item likelihood of travelling.
\end{inparaenum} The implementation of these concepts is explained in detail in \todo{ref}.
\item[Calculate the option seller's WTA] the \emph{Willingness To Accept} of an option according to the external party is calculated using its predictions of how the airfare is expected to change. This variable is dependant upon two parameters, namely: \begin{inparaenum}[\itshape (i)\upshape]
    \item Forecasting technique, and
    \item information transparency.
    \end{inparaenum} These parameters will be described in detail in \todo{ref}.
\item[Compare the WTP with the WTA] by comparing the customer's WTP and the seller's WTA, the model can determine whether the customer will buy the offered option. This is the case when the Willingness To Pay of the customer for a certain flight is higher than the Willingness To Accept of the seller (i.e., $\text{WTP} \ge \text{WTA}$).
\item[Sell the option] when the customer will buy the option, the simulation will ``sell'' the option at the specified price.
\item[Calculate generated profits] when an option is sold to a passenger, the model first checks whether the customer actually wants to exercise its right on the day of maturity. A customer will only exercise its right when he is actually flying, and the airfare on the date of maturity is higher than the strike price $p_s$. When this is the case, the simulation will compare the airfare at maturity with the strike price, and calculate the profits or losses resulted from the sale of the product. In this paper the strike price of the option is equal to the airfare at the moment of offering the airfare~lock-in product.
\end{description}

The whole process described above is summarized in \todo{ref}.

\todo{Illustration of process}

Using the method described above, the simulation will be used to compare the performance of the proposed option valuation models amongst each other. The same procedure will also be used to test the influence of a particular configuration of parameters within a single option valuation model.

\subsection{Parameters of the simulation model}
As stated in the previous section, when calculating the customer's WTP and the seller's WTA, some parameters come to play. This section will elaborate on the precise implementation of these configurable options.


\paragraph{Option's number of days to maturity}
The parameter describing the number of days to maturity is directly related to the airfare~lock-in product itself. This property can be construed as the extra decision time a customer will gain from purchasing the option and gives the passenger the opportunity to wait a specific number of days $m$ without risking a fare fluctuation. This simulation will examine the effects on relative profits of offering options with 3, 7 and 14~days to maturity.

\todo{expectations?}

\paragraph{Passenger's arrival rate}
As described in previous section, this simulation will generate passengers to determine the performance of each model and configuration of parameters. A passenger will arrive at every day before the departure of the flight for the full observed 42~days. The number of customer arrivals is thus fixed per simulation and can be expressed as $42 - m$, where $m$ is the number of days to maturity.

\paragraph{Passenger's risk-utility}
In a risk neutral setting with shared information between seller and buyer, there would be no possibility of expected profits for the option writer. This is because the customer's Willingness To Pay will never exceed the Willingness To Accept of the seller. However, customers tend to be risk averse, and are therefore willing to pay something extra in order to prevent risk \todo[(ref)]{literature}. This means that these risk averse customers agree to pay for a premium on top of the current price of a ticket to fixate the price. The concept of such a risk premium thus allows for expected profits in a situation of equal information.

In this thesis, the level of risk aversion is simulated using the exponential risk-utility function for costs:
$$
u(p_t) = -e^{p_t/R},\hspace{2em}\text{where } R > 0
$$

The parameter $R$ is the level of risk aversion of a subject, which will approach risk neutrality as $R \rightarrow \infty$. The precise value of parameter $R$ is calculated using a certain risk premium $RP$. This premium is a percentage of the current price which the customer is willing to pay extra to buy off the risk. Because the parameter $R$ is influenced by different distributions of expected prices, this research will compute the value by considering a hypothetical situation: the customer will have the same utility for a fixed fare increased by $RP$ as for a variable price that has a 50\% probability of dropping half its value and a 50\% probability of increasing with half its value. This can be expressed using the following equation: 

\begin{align*}
    (1 + RP) \times p_t &= u^{-1}(0.5 \times u(0.5 \times p_t) + 0.5 \times u(1.5 \times p_t)) \\
    u^{-1}(x) &= R \log(-x)
\end{align*}

As an example, consider that the current ticket price is \$\,250, and the customer has a $RP$ of 10\%. Instead of buying the ticket immediately, the passenger wishes to wait till a later moment in time. He knows that the fare will not be stable, but will either have a 50\% probability of dropping to \$\,125, or a 50\% change of increasing to \$\,375. A risk neutral customer is not willing to pay anything for an option that fixates the fare at \$\,250, because $.5 \times 125 + .5 * 375 = 250$. However, the customer in this hypothetical setting is not risk neutral, but rather risk averse. As stated before, he is willing to pay a $RP$ of 10\% extra to fixate the price at \$\,250 instead of running the risk of a price increase:

$$
(1 + 0.10) \times 250 = 0.5 \times u(0.5 \times 250) + 0.5 \times u(1.5 \times 250)
$$

In which $R$ will thus have the value of 305, which leads to the risk-utility function of this specific customer of
$$ u(p_t) = -e^{p_t/305} $$

The function is also represented in \autoref{fig:RiskUtilityFunctionOfPassenger}. In this figure, one can see that the passenger's utility for a fixed price of \$\,250 is
$$ -e^{250/305} = -2.27$$

However, because of the uncertainties of price changes in the future airfare, the customer's utility in the hypothetical setting is
$$0.5 \times e^{125/305}+0.5 \times e^{375/305} = -2.46$$

This utility corresponds to a value of \$\,275, or 10\% risk premium on top of the current price. The increased price the passenger is willing to pay thereby thus implies the risk neutrality of the passenger.

\begin{figure*}
	\centering
	\begin{tikzpicture}[domain=125:500]
        \begin{axis}[xlabel=price (\$), ylabel=$-\exp{(\frac{x}{305})}$, title=Risk utility function]
            \addplot[mark=none] {-exp(x/(1.22*250)}; 
            %\addlegendentry{$-e^{(\frac{x}{1.22*250})}$}
            \draw[dashed] (axis cs:250,\pgfkeysvalueof{/pgfplots/ymin}) -- (axis cs:250,-2.27);
            \draw[dashed] (axis cs:0,-2.27) -- (axis cs:250,-2.27);
            \draw[dotted,thick] (axis cs:275,\pgfkeysvalueof{/pgfplots/ymin}) -- (axis cs:275,-2.46);
            \draw[dotted,thick] (axis cs:0,-2.46) -- (axis cs:275,-2.46);
		\end{axis}
	\end{tikzpicture}
	\caption{Risk-utility function of passenger}
    \label{fig:RiskUtilityFunctionOfPassenger}
\end{figure*}

After determining the risk-utility function of a passenger, the model can calculate the utility of other situations. It can do so by calculating the utility of a certain set $S = \left\{ p_1, p_2, \ldots, p_n\right\}$ where $p_n$ is a possible future price with probability $P^{p_n}$ of occurring using the following formula.
$$
u(S) = \sum (\forall x \in S: P^{p_n} \times -e^{x/R})
$$

The price a passenger is than willing to pay is the inverse of this utility:

$$
u^{-1}(u(S)) = R \log(-u(S))
$$


\paragraph{Passenger's forecasting technique}
In this research, customers will base their forecast upon a series of historical airfares and probabilities. Theses series can consist of different levels of specificity, namely: \begin{inparaenum}[\itshape (i)\upshape]
    \item at route level,
    \item at airliner level, and
    \item at a global level.
    \end{inparaenum} When a passenger bases his forecast on a series with specificity \emph{route level}, he will --- as it were --- have all the historical airfare changes of that specific route at his disposal. As an example, consider a customer that wants to decide whether he will buy an option for the flight from AMS to JFK with a maturity of 3~days at 14~days before departure. To make his forecast, he will lookup all the historical airfares of the route AMS to JFK at 14~days before departure in the training set, and compare these with all the fares 3~days later. The passenger will thereby thus get an empirical distribution with relative price changes of an exact same option in the historical dataset. This series will then in combination with the passenger's risk utility be used to compute the customer's forecast.

    The \emph{airliner level} of specificity will look only at historical prices from a specific airliner. So, for example, when a customer wishes to decide whether he wants to buy an option on a flight from DFW to SFO flying Continental, he will only look at the historical prices of that certain airline (i.e., Continental) flying in that specific route (i.e., DFW to SFO).

The most aggregated technique of forecasting is when the passenger will base his forecasts upon a global level. This means that the customer will use \emph{all} the historical prices found in the historical dataset and base his predictions on the empirical distribution of all airfare changes occurred in the training set.

%Another forecasting technique of a passenger is by letting them use a complete random distribution of price changes 

\paragraph{Passenger's likelihood of travelling}
The passenger's likelihood of travelling represents the probability of the passenger actually wanting to buy a flight ticket at the time of maturity. This parameter $P^f$ is a value between 0 and 1, which represent \emph{certainly \textbf{not} flying} and \emph{certainly flying} respectively. At the time of computing the passenger's WTP, the passenger \emph{does} know the exact value of this variable. Furthermore, the seller will also know the exact level of the parameter during its computation of his Willingness To Accept.

Whether the passenger actually decides to fly at maturity is simulated by drawing a random variable from a uniform distribution $r^f = U(0,1)$. When $r^f \le P^f$ the passenger decides to fly, and when $r^f > P^f$ he decides not to do so. Whether the passenger actually wants to exercise the option thus depends on the outcome of this simulation, and whether the strike price $p_s$ is littler than the airfare at maturity (i.e., $p_s < p_{t+m}$).

\paragraph{Seller's forecasting technique}
Next to the forecasting technique of the buyer of the airfare~lock-in product, the seller will also use different types of methods to create its forecasts. These techniques are closely related to the three option valuation methods described in \autoref{subsec:OptionValuationModels}.

\begin{description}
\item[Foreknowledge] The first method, based upon foreknowledge of the seller, will suppose that the seller knows what the airfares will be at the time of maturity. This thus implies that the option writer can look into the future, and is merely a hypothetical scenario. As stated in the previous chapter, this setting is not possible in a realistic world, but does offer some insights into the possibilities of supplying airfare~lock-in products. For example, using this forecasting method in combination with the seller's property \emph{all knowing} (see \todo{ref}) will yield the maximum profit a seller can possibly make in settings defined by the configuration of customer's parameter. This technique will thus supply a `steady' base case to compare the other two methods to. The maximum Willingness To Accept for the seller for a specific ticket can thus be defined as the maximum of 0 or the price at maturity minus the current price:

$$
\max(0, p_{t+m} - p_t)
$$


\item[Random price jumps] The second method of forecasting will assume non-predictability and random price jumps. In this scenario the seller believes it is not possible to predict future prices, and will thus estimate the future price of a ticket using historical volatility data. This method is thus the first of the two practically feasible methods that an airfare~lock-in seller in the realistic world can apply. This research will use the historical volatility as seen in the acquired training dataset to make forecasts of future price changes.

\item[Emperical distribution] The third possible forecasting technique, and other practically feasible method, is based upon the assumption that the price changes can be predicted using historical data. This thesis will use a Monte~Carlo simulation upon the empirical data as acquired in the training dataset to determine the best option price for that historical data. The same price will then be used for the airfare~lock-in product offered to the customer.
\end{description}

\paragraph{Seller's information transparency}
In the simulation model there are several parameters that are engaged with information transparency --- or information sharing --- between the customer and the seller. To limit the total number of possible scenarios, some of these parameters have been fixated.

Firstly, this research assumes that the seller always knows the exact level of a customer's likelihood of travelling, $P^f$. This might not always be the case in a real world setting, but it might be possible to let the customer give away this information. As an example implementation of this see \todo{article Courty} and \todo[ref]{Further research}.

Next, it is also assumed that the seller knows the customer's Willingness To Pay, and will thus always offer an option at the maximum possible price (i.e., at the customer's \emph{WTP}).

This research, however, does make a distinction between two different cases of information transparency of the customer's actual decision of flying. The first case, in which there is an \emph{all knowing} seller, assumes that the seller knows whether a customer is going to fly on the date of maturity. It is not possible for a seller to know this kind of information in the real world, even before the actual passenger knows this. However, this specific case is usefull in combination with the \emph{foreknowledge} forecasting technique. That specific setting will give insights in the maximum possible profits a seller gains in a situation in which it has all information.

The other case that is considered does assume the Seller does not have this kind of information, and will thus be applied in combination with the other two forecasting techniques.

\paragraph{Simulation's number of trials}
Because pseudo random generation of numbers and probabilities are used in this model, there is a possibility of generating outliers in only a single run. To prevent such scenarios from happening, every simulation is run a vast amount of times. The acquired data from these multiple trials is then averaged to get the converged mean.

The convergence plot of three example flights is shown in \autoref{fig:ConvergencePlotMultiple}. As can be seen in the figure, the mean seems to stabilize at around 2,500~trials. This research will therefore use the average of 2,500~trials for every simulation.

\begin{figure*}
\centering
\includegraphics[width=0.8\textwidth]{figures/ConvergencePlot_multiple}
\caption{Convergence plot}
\label{fig:ConvergencePlotMultiple}
\end{figure*}


\subsection{Configurations}
<describe different parameter configurations>



%Future research
%passenger arrival rate to de Boer and Wetherford

%is it really bad? => surplus



%TODO
%- Table for total of flights per out/inbound dest, and operating carrier
%- Analysis of sold-out flights

